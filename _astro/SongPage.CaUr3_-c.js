import{g as te,w as ne,I as ae}from"./index-FitP4J_6.TiJPR-Ae.js";import{B as oe}from"./Breadcrumbs.CS9OMcxE.js";import{L as se}from"./LanguageSwitcher.Yk_FTewo.js";import{t as le}from"./index.sXTMffxN.js";import{b as re,c as z}from"./index.brZL-3I0.js";import{r as S,p as x,c as ie,w as P,j as R,B as D,f as O,k as j,o as m,a as C,e,t as f,g as h,b as M,F as U,h as q,i as I,d as J}from"./runtime-core.esm-bundler.Yc9PgZSd.js";/* empty css                      */import{_ as ce}from"./_plugin-vue_export-helper.DlAUqK2U.js";import"./runtime-dom.esm-bundler.BU_tAFEj.js";/* empty css                      */import"./index.DURh_9Xy.js";/* empty css                      */function F(w){const g=S([]),n=S({});let t=null;const r=()=>{g.value=JSON.parse(localStorage.getItem("songsData"))||[],n.value=x(g).find(a=>a.key===w.key)||{key:w.key,listenTime:0,totalTime:w.duration||0,finished:!1,like:!1,startedAt:null,completedAt:null}},i=()=>{let a=JSON.parse(localStorage.getItem("songsData"))||[];a=a.filter(p=>p&&p.key);const _=a.findIndex(p=>p.key===w.key);_===-1?a.push(x(n)):a[_]=x(n),localStorage.setItem("songsData",JSON.stringify(a)),typeof window<"u"&&window.dispatchEvent(new Event("storage:updated"))},l=()=>{let a=n.value;if(!a||typeof a.listenTime!="number"){console.warn("Invalid song data during listen time update");return}a.listenTime+=1,c().current>=90&&!a.finished&&(a.finished=!0,a.completedAt=Date.now(),console.log("CanciÃ³n marcada como completada:",a.key,"a las",new Date(a.completedAt).toLocaleTimeString())),n.value=a,i()},u=()=>{r(),n.value&&!n.value.startedAt&&(n.value.startedAt=Date.now()),i(),t||(t=setInterval(l,1e3))},k=()=>{t&&(clearInterval(t),t=null)},T=()=>{k();let a=n.value;if(!a){console.warn("No song data available on end");return}a.finished=!0,a.completedAt||(a.completedAt=Date.now(),console.log("Song completed at:",new Date(a.completedAt).toISOString())),n.value=a,i()},b=a=>{const _=n.value;if(!_){console.warn("No song data available to set like status");return}_.like=a,n.value=_,i()},c=()=>{try{r();const a=x(n),_=a.totalTime?Math.ceil(a.listenTime/a.totalTime*100):0,p=_>100?100:_;return{...a,current:p}}catch{return{}}};return{onSongStart:u,onSongPause:k,onSongEnd:T,setLikeStatus:b,setDuration:a=>{n.value&&(n.value.totalTime=a,console.log("useSong - Duration set to:",a),i())},getCurrentStatus:c,isComplete:()=>c().current>=90,cleanup:()=>{t&&(clearInterval(t),t=null)}}}const ge={__name:"SongPage",props:{song:{type:Object,required:!0},allSongs:{type:Array,default:()=>[]},currentSaga:{type:Object,default:null},relatedStory:{type:Object,default:null}},setup(w,{expose:g}){g();const n="es",t=o=>{if(!o)return"";const s=/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/,d=o.match(s);return d&&d[2].length===11?d[2]:o},r=w,i=S(!1),l=S(!0),u=S(!1),k=S(!1),T=S(0),b=S(-1);let c=null,v=null,y=null;const N=R(()=>r.song.lyrics?r.song.lyrics.replace(/\r\n/g,`
`).replace(/\r/g,`
`).replace(/<br\s*\/?>/gi,`
`).replace(/\n{3,}/g,`

`).replace(/\n/g,"<br>"):""),a=o=>T.value>=o.start&&T.value<o.end,_=o=>o?o.replace(/\r\n/g,`
`).replace(/\r/g,`
`).replace(/\n/g,"<br>"):"";D(T,()=>{if(!r.song.syncedLyrics||r.song.syncedLyrics.length===0)return;const o=r.song.syncedLyrics.findIndex(s=>a(s));if(o!==b.value&&(b.value=o,o!==-1)){const s=document.querySelector(".song-page__karaoke-content"),d=document.querySelectorAll(".song-page__karaoke-line")[o];if(s&&d){const X=d.offsetTop-s.offsetTop,Z=d.clientHeight,$=s.clientHeight,ee=X-$/2+Z/2;s.scrollTo({top:ee,behavior:"smooth"})}}});const p=()=>{v&&clearInterval(v),v=setInterval(()=>{c&&typeof c.getCurrentTime=="function"&&(T.value=c.getCurrentTime())},100)},G=()=>{i.value=!i.value,i.value&&(l.value=!1,u.value=!1)},W=()=>{l.value=!l.value,l.value&&(i.value=!1)},K=()=>{u.value=!u.value,u.value&&(i.value=!1)},Q=o=>{c&&typeof c.seekTo=="function"&&(c.seekTo(o.start,!0),c.getPlayerState&&c.getPlayerState()!==window.YT.PlayerState.PLAYING&&c.playVideo())},V=()=>{i.value?c?.playVideo():l.value&&B()},B=()=>{const o=r.allSongs.findIndex(s=>s.key===r.song.key);if(u.value){let s;do s=Math.floor(Math.random()*r.allSongs.length);while(s===o&&r.allSongs.length>1);const d=r.allSongs[s];L(d.key)}else if(o!==-1)if(o<r.allSongs.length-1){const s=r.allSongs[o+1];L(s.key)}else{const s=r.allSongs[0];L(s.key)}},L=o=>{window.location.href=z(o)},H=()=>{if(window.YT)A();else{const o=document.createElement("script");o.src="https://www.youtube.com/iframe_api";const s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(o,s),window.onYouTubeIframeAPIReady=A}},A=()=>{const o=t(r.song.song);c=new window.YT.Player(`youtube-player-${r.song.key}`,{videoId:o,width:"100%",height:"100%",playerVars:{autoplay:1,rel:0,modestbranding:1,cc_load_policy:1},events:{onReady:s=>{window.__ytPlayer=s.target,p();const d=s.target.getDuration();y&&d>0&&y.setDuration(d)},onStateChange:s=>{s.data===window.YT.PlayerState.ENDED&&(V(),y&&y.onSongEnd()),s.data===window.YT.PlayerState.PLAYING&&(k.value=!0,p(),y&&y.onSongStart()),s.data===window.YT.PlayerState.PAUSED&&(v&&clearInterval(v),y&&y.onSongPause())}}})};O(()=>{k.value=!0;const o=localStorage.getItem("songRepeat"),s=localStorage.getItem("songAutoplay"),d=localStorage.getItem("songShuffle");o!==null&&(i.value=o==="true"),s!==null&&(l.value=s==="true"),d!==null&&(u.value=d==="true"),y=F(r.song),H()});const E=()=>{localStorage.setItem("songRepeat",i.value),localStorage.setItem("songAutoplay",l.value),localStorage.setItem("songShuffle",u.value)};D([i,l,u],E),j(()=>{v&&clearInterval(v),y&&y.cleanup()});const Y={lang:n,extractYoutubeId:t,props:r,isRepeat:i,isAutoplay:l,isShuffle:u,isPlaying:k,currentTime:T,activeLineIndex:b,get player(){return c},set player(o){c=o},get timeUpdateInterval(){return v},set timeUpdateInterval(o){v=o},get songTracker(){return y},set songTracker(o){y=o},lyricsHTML:N,isLineActive:a,normalizeLineText:_,startTimeTracking:p,toggleRepeat:G,toggleAutoplay:W,toggleShuffle:K,seekToLine:Q,handleSongEnded:V,playNextSong:B,navigateToSong:L,initYouTubePlayer:H,createPlayer:A,savePreferences:E,get VText(){return ae},get VButton(){return ne},get VContainer(){return te},Breadcrumbs:oe,LanguageSwitcher:se,ref:S,computed:R,onMounted:O,onUnmounted:j,watch:D,get t(){return le},get toSong(){return z},get toStory(){return re},get useSong(){return F}};return Object.defineProperty(Y,"__isScriptSetup",{enumerable:!1,value:!0}),Y}},ue={class:"song-page__title"},de={class:"song-page__layout"},ye={class:"song-page__main"},_e={class:"song-page__video-container"},fe=["id"],ve={key:0,class:"song-page__karaoke"},pe={class:"song-page__karaoke-title"},me={class:"song-page__karaoke-content"},he=["onClick","innerHTML"],Se={class:"song-page__controls-section"},ke={key:1,class:"song-page__story-card"},we=["href"],Te={class:"song-page__story-image"},be=["src","alt"],Ie={class:"song-page__story-info"},Le={class:"song-page__story-label"},xe={class:"song-page__story-title"},Ce={key:2,class:"song-page__lyrics"},Ae={class:"song-page__lyrics-title"},Pe=["innerHTML"],De={class:"song-page__playlist"},Me={class:"song-page__playlist-items"},Ne=["onClick"],Ve={class:"song-page__playlist-number"},Be={key:0},He={key:1,viewBox:"0 0 24 24",fill:"currentColor"},Ee={class:"song-page__playlist-cover"},Ye=["src","alt"],ze={class:"song-page__playlist-info"};function Re(w,g,n,t,r,i){return m(),ie(t.VContainer,{size:"xl",class:"song-page"},{default:P(()=>[C(t.Breadcrumbs,{"current-page":n.song.name,"saga-name":n.currentSaga?.name,"saga-key":n.currentSaga?.key},null,8,["current-page","saga-name","saga-key"]),C(t.LanguageSwitcher,{order:n.song.order,type:"song",class:"song-page__language-switcher"},null,8,["order"]),e("h1",ue,f(n.song.name),1),e("div",de,[e("div",ye,[e("div",_e,[e("div",{id:`youtube-player-${n.song.key}`,class:"song-page__video"},null,8,fe)]),n.song.syncedLyrics&&n.song.syncedLyrics.length>0?(m(),h("div",ve,[e("h2",pe,f(t.t("page.song.lyrics")),1),e("div",me,[(m(!0),h(U,null,q(n.song.syncedLyrics,(l,u)=>(m(),h("div",{key:u,class:I({"song-page__karaoke-line":!0,"song-page__karaoke-line--active":t.isLineActive(l)}),onClick:k=>t.seekToLine(l),innerHTML:t.normalizeLineText(l.text),suppressHydrationWarning:""},null,10,he))),128))])])):M("",!0),e("div",Se,[e("button",{onClick:t.toggleRepeat,class:I([{active:t.isRepeat},"song-page__control"])},[g[0]||(g[0]=e("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M17 1l4 4-4 4M3 11V9a4 4 0 0 1 4-4h14M7 23l-4-4 4-4M21 13v2a4 4 0 0 1-4 4H3"})],-1)),e("span",null,f(t.t("page.song.repeat")),1)],2),e("button",{onClick:t.toggleAutoplay,class:I([{active:t.isAutoplay},"song-page__control"])},[g[1]||(g[1]=e("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M5 3l14 9-14 9V3z"}),e("path",{d:"M19 3v18"})],-1)),e("span",null,f(t.t("page.song.autoplay")),1)],2),e("button",{onClick:t.toggleShuffle,class:I([{active:t.isShuffle},"song-page__control"])},[g[2]||(g[2]=e("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"})],-1)),e("span",null,f(t.t("page.song.shuffle")),1)],2)]),n.relatedStory?(m(),h("div",ke,[e("a",{href:t.toStory(n.relatedStory.key),class:"song-page__story-link"},[e("div",Te,[e("img",{src:`/assets/stories/${t.lang}/${n.relatedStory.key}.webp`,alt:n.relatedStory.name},null,8,be)]),e("div",Ie,[e("span",Le,f(t.t("page.song.readStory")),1),e("h3",xe,f(n.relatedStory.name),1)]),g[3]||(g[3]=e("svg",{class:"song-page__story-arrow",viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"})],-1))],8,we)])):M("",!0),n.song.lyrics&&(!n.song.syncedLyrics||n.song.syncedLyrics.length===0)?(m(),h("div",Ce,[e("h2",Ae,f(t.t("page.song.lyrics")),1),e("div",{class:"song-page__lyrics-content",innerHTML:t.lyricsHTML,suppressHydrationWarning:""},null,8,Pe)])):M("",!0)]),e("div",De,[C(t.VText,{variant:"subtitle",color:"high",class:"song-page__playlist-title"},{default:P(()=>[J(f(t.t("page.song.playlist")),1)]),_:1}),e("div",Me,[(m(!0),h(U,null,q(n.allSongs,(l,u)=>(m(),h("div",{key:l.key,class:I([{"song-page__playlist-item--active":l.key===n.song.key,"song-page__playlist-item--playing":t.isPlaying&&l.key===n.song.key},"song-page__playlist-item"]),onClick:k=>t.navigateToSong(l.key)},[e("div",Ve,[!t.isPlaying||l.key!==n.song.key?(m(),h("span",Be,f(u+1),1)):(m(),h("svg",He,[...g[4]||(g[4]=[e("rect",{x:"6",y:"4",width:"4",height:"16",rx:"1"},[e("animate",{attributeName:"height",values:"4;16;4",dur:"1.2s",repeatCount:"indefinite",begin:"0s"}),e("animate",{attributeName:"y",values:"10;4;10",dur:"1.2s",repeatCount:"indefinite",begin:"0s"})],-1),e("rect",{x:"14",y:"4",width:"4",height:"16",rx:"1"},[e("animate",{attributeName:"height",values:"16;4;16",dur:"1.2s",repeatCount:"indefinite",begin:"0.3s"}),e("animate",{attributeName:"y",values:"4;10;4",dur:"1.2s",repeatCount:"indefinite",begin:"0.3s"})],-1)])]))]),e("div",Ee,[e("img",{src:`/assets/stories/${t.lang}/${l.key}.webp`,alt:l.name},null,8,Ye)]),e("div",ze,[C(t.VText,{variant:"body",color:"high"},{default:P(()=>[J(f(l.name),1)]),_:2},1024)])],10,Ne))),128))])])])]),_:1})}const $e=ce(ge,[["render",Re]]);export{$e as default};
