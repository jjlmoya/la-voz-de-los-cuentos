import{g as $,w as ee,I as te}from"./index-FitP4J_6.BPTo_1p2.js";import{B as ne}from"./Breadcrumbs.CWDIuUqc.js";import{L as ae}from"./LanguageSwitcher.BIVd48vC.js";import{t as oe}from"./index.Br1Li-Ke.js";import{b as se,c as j}from"./index.brZL-3I0.js";import{r as h,p as x,c as le,w as P,k as U,B as M,f as q,l as J,o as v,a as C,e,t as f,g as p,b as B,F,h as G,j as b,d as K}from"./runtime-core.esm-bundler.BLIdz6c-.js";/* empty css                      */import{_ as re}from"./_plugin-vue_export-helper.DlAUqK2U.js";import"./runtime-dom.esm-bundler.BbeENm1T.js";/* empty css                      */import"./index.CqFlbLC_.js";import"./landings.D6rrVUZj.js";/* empty css                      */function Q(S){const g=h([]),n=h({});let t=null;const r=()=>{g.value=JSON.parse(localStorage.getItem("songsData"))||[],n.value=x(g).find(o=>o.key===S.key)},i=()=>{const o=JSON.parse(localStorage.getItem("songsData"))||[],_=x(g).findIndex(T=>T.key===S.key);_===-1&&o.push({key:S.key,listenTime:0,totalTime:S.duration||0,finished:!1,like:!1,startedAt:null,completedAt:null}),o[_]=x(n),localStorage.setItem("songsData",JSON.stringify(o))},l=()=>{let o=n.value;o.listenTime+=1,o.totalTime&&o.listenTime>=o.totalTime*.9&&(o.finished=!0,o.completedAt||(o.completedAt=Date.now())),n.value=o,i()},c=()=>{r(),i(),n.value&&!n.value.startedAt&&(n.value.startedAt=Date.now(),i()),t||(t=setInterval(l,1e3))},k=()=>{t&&(clearInterval(t),t=null)},w=()=>{k();let o=n.value;o.finished=!0,o.completedAt||(o.completedAt=Date.now()),n.value=o,i()},m=o=>{const _=n.value;_.like=o,n.value=_,i()},u=()=>{try{r();const o=x(n),_=o.totalTime?Math.ceil(o.listenTime/o.totalTime*100):0,T=_>100?100:_;return{...o,current:T}}catch{return{}}};return{onSongStart:c,onSongPause:k,onSongEnd:w,setLikeStatus:m,getCurrentStatus:u,isComplete:()=>u().current>=90,cleanup:()=>{t&&(clearInterval(t),t=null)}}}const ie={__name:"SongPage",props:{song:{type:Object,required:!0},allSongs:{type:Array,default:()=>[]},currentSaga:{type:Object,default:null},relatedStory:{type:Object,default:null}},setup(S,{expose:g}){g();const n="es",t=s=>{if(!s)return"";const a=/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/,y=s.match(a);return y&&y[2].length===11?y[2]:s},r=S,i=h(!1),l=h(!0),c=h(!1),k=h(!1),w=h(0);let m=null,u=null,d=null;const N=U(()=>r.song.lyrics?r.song.lyrics.replace(/<br\s*\/?>/gi,`
`).replace(/\n{3,}/g,`

`).replace(/\n/g,"<br>"):""),o=s=>w.value>=s.start&&w.value<s.end;M(w,()=>{if(!r.song.syncedLyrics||r.song.syncedLyrics.length===0)return;const s=r.song.syncedLyrics.findIndex(a=>o(a));if(s!==-1){const a=document.querySelector(".song-page__karaoke-content"),y=document.querySelectorAll(".song-page__karaoke-line")[s];if(a&&y){const Y=a.scrollTop,z=a.clientHeight,A=y.offsetTop-a.offsetTop,O=y.clientHeight,Z=A-z/2+O/2;(A<Y||A+O>Y+z)&&a.scrollTo({top:Z,behavior:"smooth"})}}});const _=()=>{u&&clearInterval(u),u=setInterval(()=>{m&&typeof m.getCurrentTime=="function"&&(w.value=m.getCurrentTime())},100)},T=()=>{i.value=!i.value,i.value&&(l.value=!1,c.value=!1)},W=()=>{l.value=!l.value,l.value&&(i.value=!1)},X=()=>{c.value=!c.value,c.value&&(i.value=!1)},V=()=>{i.value?m?.playVideo():l.value&&D()},D=()=>{const s=r.allSongs.findIndex(a=>a.key===r.song.key);if(c.value){let a;do a=Math.floor(Math.random()*r.allSongs.length);while(a===s&&r.allSongs.length>1);const y=r.allSongs[a];I(y.key)}else if(s!==-1)if(s<r.allSongs.length-1){const a=r.allSongs[s+1];I(a.key)}else{const a=r.allSongs[0];I(a.key)}},I=s=>{window.location.href=j(s)},E=()=>{if(window.YT)L();else{const s=document.createElement("script");s.src="https://www.youtube.com/iframe_api";const a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(s,a),window.onYouTubeIframeAPIReady=L}},L=()=>{const s=t(r.song.song);m=new window.YT.Player(`youtube-player-${r.song.key}`,{videoId:s,width:"100%",height:"100%",playerVars:{autoplay:1,rel:0,modestbranding:1,cc_load_policy:1},events:{onReady:a=>{window.__ytPlayer=a.target,_()},onStateChange:a=>{a.data===window.YT.PlayerState.ENDED&&(V(),d&&d.onSongEnd()),a.data===window.YT.PlayerState.PLAYING&&(k.value=!0,_(),d&&d.onSongStart()),a.data===window.YT.PlayerState.PAUSED&&(u&&clearInterval(u),d&&d.onSongPause())}}})};q(()=>{k.value=!0;const s=localStorage.getItem("songRepeat"),a=localStorage.getItem("songAutoplay"),y=localStorage.getItem("songShuffle");s!==null&&(i.value=s==="true"),a!==null&&(l.value=a==="true"),y!==null&&(c.value=y==="true"),d=Q(r.song),E()});const H=()=>{localStorage.setItem("songRepeat",i.value),localStorage.setItem("songAutoplay",l.value),localStorage.setItem("songShuffle",c.value)};M([i,l,c],H),J(()=>{u&&clearInterval(u),d&&d.cleanup()});const R={lang:n,extractYoutubeId:t,props:r,isRepeat:i,isAutoplay:l,isShuffle:c,isPlaying:k,currentTime:w,get player(){return m},set player(s){m=s},get timeUpdateInterval(){return u},set timeUpdateInterval(s){u=s},get songTracker(){return d},set songTracker(s){d=s},lyricsHTML:N,isLineActive:o,startTimeTracking:_,toggleRepeat:T,toggleAutoplay:W,toggleShuffle:X,handleSongEnded:V,playNextSong:D,navigateToSong:I,initYouTubePlayer:E,createPlayer:L,savePreferences:H,get VText(){return te},get VButton(){return ee},get VContainer(){return $},Breadcrumbs:ne,LanguageSwitcher:ae,ref:h,computed:U,onMounted:q,onUnmounted:J,watch:M,get t(){return oe},get toSong(){return j},get toStory(){return se},get useSong(){return Q}};return Object.defineProperty(R,"__isScriptSetup",{enumerable:!1,value:!0}),R}},ge={class:"song-page__title"},ce={class:"song-page__layout"},ue={class:"song-page__main"},de={class:"song-page__video-container"},_e=["id"],ye={key:0,class:"song-page__karaoke"},fe={class:"song-page__karaoke-title"},ve={class:"song-page__karaoke-content"},me={class:"song-page__controls-section"},pe={key:1,class:"song-page__story-card"},he=["href"],Se={class:"song-page__story-image"},ke=["src","alt"],we={class:"song-page__story-info"},Te={class:"song-page__story-label"},be={class:"song-page__story-title"},Ie={key:2,class:"song-page__lyrics"},xe={class:"song-page__lyrics-title"},Ce=["innerHTML"],Le={class:"song-page__playlist"},Ae={class:"song-page__playlist-items"},Pe=["onClick"],Me={class:"song-page__playlist-number"},Be={key:0},Ne={key:1,viewBox:"0 0 24 24",fill:"currentColor"},Ve={class:"song-page__playlist-cover"},De=["src","alt"],Ee={class:"song-page__playlist-info"};function He(S,g,n,t,r,i){return v(),le(t.VContainer,{size:"xl",class:"song-page"},{default:P(()=>[C(t.Breadcrumbs,{"current-page":n.song.name,"saga-name":n.currentSaga?.name,"saga-key":n.currentSaga?.key},null,8,["current-page","saga-name","saga-key"]),C(t.LanguageSwitcher,{order:n.song.order,type:"song",class:"song-page__language-switcher"},null,8,["order"]),e("h1",ge,f(n.song.name),1),e("div",ce,[e("div",ue,[e("div",de,[e("div",{id:`youtube-player-${n.song.key}`,class:"song-page__video"},null,8,_e)]),n.song.syncedLyrics&&n.song.syncedLyrics.length>0?(v(),p("div",ye,[e("h2",fe,f(t.t("page.song.lyrics")),1),e("div",ve,[(v(!0),p(F,null,G(n.song.syncedLyrics,(l,c)=>(v(),p("div",{key:c,class:b({"song-page__karaoke-line":!0,"song-page__karaoke-line--active":t.isLineActive(l)})},f(l.text),3))),128))])])):B("",!0),e("div",me,[e("button",{onClick:t.toggleRepeat,class:b([{active:t.isRepeat},"song-page__control"])},[g[0]||(g[0]=e("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M17 1l4 4-4 4M3 11V9a4 4 0 0 1 4-4h14M7 23l-4-4 4-4M21 13v2a4 4 0 0 1-4 4H3"})],-1)),e("span",null,f(t.t("page.song.repeat")),1)],2),e("button",{onClick:t.toggleAutoplay,class:b([{active:t.isAutoplay},"song-page__control"])},[g[1]||(g[1]=e("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M5 3l14 9-14 9V3z"}),e("path",{d:"M19 3v18"})],-1)),e("span",null,f(t.t("page.song.autoplay")),1)],2),e("button",{onClick:t.toggleShuffle,class:b([{active:t.isShuffle},"song-page__control"])},[g[2]||(g[2]=e("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"})],-1)),e("span",null,f(t.t("page.song.shuffle")),1)],2)]),n.relatedStory?(v(),p("div",pe,[e("a",{href:t.toStory(n.relatedStory.key),class:"song-page__story-link"},[e("div",Se,[e("img",{src:`/assets/stories/${t.lang}/${n.relatedStory.key}.webp`,alt:n.relatedStory.name},null,8,ke)]),e("div",we,[e("span",Te,f(t.t("page.song.readStory")),1),e("h3",be,f(n.relatedStory.name),1)]),g[3]||(g[3]=e("svg",{class:"song-page__story-arrow",viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"})],-1))],8,he)])):B("",!0),n.song.lyrics&&(!n.song.syncedLyrics||n.song.syncedLyrics.length===0)?(v(),p("div",Ie,[e("h2",xe,f(t.t("page.song.lyrics")),1),e("div",{class:"song-page__lyrics-content",innerHTML:t.lyricsHTML},null,8,Ce)])):B("",!0)]),e("div",Le,[C(t.VText,{variant:"subtitle",color:"high",class:"song-page__playlist-title"},{default:P(()=>[K(f(t.t("page.song.playlist")),1)]),_:1}),e("div",Ae,[(v(!0),p(F,null,G(n.allSongs,(l,c)=>(v(),p("div",{key:l.key,class:b([{"song-page__playlist-item--active":l.key===n.song.key,"song-page__playlist-item--playing":t.isPlaying&&l.key===n.song.key},"song-page__playlist-item"]),onClick:k=>t.navigateToSong(l.key)},[e("div",Me,[!t.isPlaying||l.key!==n.song.key?(v(),p("span",Be,f(c+1),1)):(v(),p("svg",Ne,[...g[4]||(g[4]=[e("rect",{x:"6",y:"4",width:"4",height:"16",rx:"1"},[e("animate",{attributeName:"height",values:"4;16;4",dur:"1.2s",repeatCount:"indefinite",begin:"0s"}),e("animate",{attributeName:"y",values:"10;4;10",dur:"1.2s",repeatCount:"indefinite",begin:"0s"})],-1),e("rect",{x:"14",y:"4",width:"4",height:"16",rx:"1"},[e("animate",{attributeName:"height",values:"16;4;16",dur:"1.2s",repeatCount:"indefinite",begin:"0.3s"}),e("animate",{attributeName:"y",values:"4;10;4",dur:"1.2s",repeatCount:"indefinite",begin:"0.3s"})],-1)])]))]),e("div",Ve,[e("img",{src:`/assets/stories/${t.lang}/${l.key}.webp`,alt:l.name},null,8,De)]),e("div",Ee,[C(t.VText,{variant:"body",color:"high"},{default:P(()=>[K(f(l.name),1)]),_:2},1024)])],10,Pe))),128))])])])]),_:1})}const Xe=re(ie,[["render",He]]);export{Xe as default};
