import{g as ee,w as te,I as ne}from"./index-FitP4J_6.BPTo_1p2.js";import{B as ae}from"./Breadcrumbs.CWDIuUqc.js";import{L as oe}from"./LanguageSwitcher.CnmKrW2J.js";import{t as se}from"./index.Br1Li-Ke.js";import{b as le,c as U}from"./index.brZL-3I0.js";import{r as S,p as x,c as re,w as P,k as q,B as M,f as J,l as F,o as p,a as L,e,t as f,g as m,b as N,F as W,h as G,j as b,d as K}from"./runtime-core.esm-bundler.BLIdz6c-.js";/* empty css                      */import{_ as ie}from"./_plugin-vue_export-helper.DlAUqK2U.js";import"./runtime-dom.esm-bundler.BbeENm1T.js";/* empty css                      */import"./index.WD-CXpjI.js";import"./landings.D6rrVUZj.js";/* empty css                      */function Q(k){const c=S([]),t=S({});let n=null;const r=()=>{c.value=JSON.parse(localStorage.getItem("songsData"))||[],t.value=x(c).find(a=>a.key===k.key)||{key:k.key,listenTime:0,totalTime:k.duration||0,finished:!1,like:!1,startedAt:null,completedAt:null}},i=()=>{let a=JSON.parse(localStorage.getItem("songsData"))||[];a=a.filter(h=>h&&h.key);const _=a.findIndex(h=>h.key===k.key);_===-1?a.push(x(t)):a[_]=x(t),localStorage.setItem("songsData",JSON.stringify(a)),typeof window<"u"&&window.dispatchEvent(new Event("storage:updated"))},l=()=>{let a=t.value;if(!a||typeof a.listenTime!="number"){console.warn("Invalid song data during listen time update");return}a.listenTime+=1,y().current>=90&&!a.finished&&(a.finished=!0,a.completedAt=Date.now(),console.log("CanciÃ³n marcada como completada:",a.key,"a las",new Date(a.completedAt).toLocaleTimeString())),t.value=a,i()},g=()=>{r(),t.value&&!t.value.startedAt&&(t.value.startedAt=Date.now()),i(),n||(n=setInterval(l,1e3))},w=()=>{n&&(clearInterval(n),n=null)},T=()=>{w();let a=t.value;if(!a){console.warn("No song data available on end");return}a.finished=!0,a.completedAt||(a.completedAt=Date.now(),console.log("Song completed at:",new Date(a.completedAt).toISOString())),t.value=a,i()},v=a=>{const _=t.value;if(!_){console.warn("No song data available to set like status");return}_.like=a,t.value=_,i()},y=()=>{try{r();const a=x(t),_=a.totalTime?Math.ceil(a.listenTime/a.totalTime*100):0,h=_>100?100:_;return{...a,current:h}}catch{return{}}};return{onSongStart:g,onSongPause:w,onSongEnd:T,setLikeStatus:v,setDuration:a=>{t.value&&(t.value.totalTime=a,console.log("useSong - Duration set to:",a),i())},getCurrentStatus:y,isComplete:()=>y().current>=90,cleanup:()=>{n&&(clearInterval(n),n=null)}}}const ce={__name:"SongPage",props:{song:{type:Object,required:!0},allSongs:{type:Array,default:()=>[]},currentSaga:{type:Object,default:null},relatedStory:{type:Object,default:null}},setup(k,{expose:c}){c();const t="es",n=o=>{if(!o)return"";const s=/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/,u=o.match(s);return u&&u[2].length===11?u[2]:o},r=k,i=S(!1),l=S(!0),g=S(!1),w=S(!1),T=S(0);let v=null,y=null,d=null;const B=q(()=>r.song.lyrics?r.song.lyrics.replace(/\r\n/g,`
`).replace(/\r/g,`
`).replace(/<br\s*\/?>/gi,`
`).replace(/\n{3,}/g,`

`).replace(/\n/g,"<br>"):""),C=o=>T.value>=o.start&&T.value<o.end,a=o=>o?o.replace(/\r\n/g,`
`).replace(/\r/g,`
`).replace(/\n/g,"<br>"):"";M(T,()=>{if(!r.song.syncedLyrics||r.song.syncedLyrics.length===0)return;const o=r.song.syncedLyrics.findIndex(s=>C(s));if(o!==-1){const s=document.querySelector(".song-page__karaoke-content"),u=document.querySelectorAll(".song-page__karaoke-line")[o];if(s&&u){const Y=s.scrollTop,O=s.clientHeight,D=u.offsetTop-s.offsetTop,j=u.clientHeight,$=D-O/2+j/2;(D<Y||D+j>Y+O)&&s.scrollTo({top:$,behavior:"smooth"})}}});const _=()=>{y&&clearInterval(y),y=setInterval(()=>{v&&typeof v.getCurrentTime=="function"&&(T.value=v.getCurrentTime())},100)},h=()=>{i.value=!i.value,i.value&&(l.value=!1,g.value=!1)},X=()=>{l.value=!l.value,l.value&&(i.value=!1)},Z=()=>{g.value=!g.value,g.value&&(i.value=!1)},V=()=>{i.value?v?.playVideo():l.value&&H()},H=()=>{const o=r.allSongs.findIndex(s=>s.key===r.song.key);if(g.value){let s;do s=Math.floor(Math.random()*r.allSongs.length);while(s===o&&r.allSongs.length>1);const u=r.allSongs[s];I(u.key)}else if(o!==-1)if(o<r.allSongs.length-1){const s=r.allSongs[o+1];I(s.key)}else{const s=r.allSongs[0];I(s.key)}},I=o=>{window.location.href=U(o)},E=()=>{if(window.YT)A();else{const o=document.createElement("script");o.src="https://www.youtube.com/iframe_api";const s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(o,s),window.onYouTubeIframeAPIReady=A}},A=()=>{const o=n(r.song.song);v=new window.YT.Player(`youtube-player-${r.song.key}`,{videoId:o,width:"100%",height:"100%",playerVars:{autoplay:1,rel:0,modestbranding:1,cc_load_policy:1},events:{onReady:s=>{window.__ytPlayer=s.target,_();const u=s.target.getDuration();d&&u>0&&d.setDuration(u)},onStateChange:s=>{s.data===window.YT.PlayerState.ENDED&&(V(),d&&d.onSongEnd()),s.data===window.YT.PlayerState.PLAYING&&(w.value=!0,_(),d&&d.onSongStart()),s.data===window.YT.PlayerState.PAUSED&&(y&&clearInterval(y),d&&d.onSongPause())}}})};J(()=>{w.value=!0;const o=localStorage.getItem("songRepeat"),s=localStorage.getItem("songAutoplay"),u=localStorage.getItem("songShuffle");o!==null&&(i.value=o==="true"),s!==null&&(l.value=s==="true"),u!==null&&(g.value=u==="true"),d=Q(r.song),E()});const z=()=>{localStorage.setItem("songRepeat",i.value),localStorage.setItem("songAutoplay",l.value),localStorage.setItem("songShuffle",g.value)};M([i,l,g],z),F(()=>{y&&clearInterval(y),d&&d.cleanup()});const R={lang:t,extractYoutubeId:n,props:r,isRepeat:i,isAutoplay:l,isShuffle:g,isPlaying:w,currentTime:T,get player(){return v},set player(o){v=o},get timeUpdateInterval(){return y},set timeUpdateInterval(o){y=o},get songTracker(){return d},set songTracker(o){d=o},lyricsHTML:B,isLineActive:C,normalizeLineText:a,startTimeTracking:_,toggleRepeat:h,toggleAutoplay:X,toggleShuffle:Z,handleSongEnded:V,playNextSong:H,navigateToSong:I,initYouTubePlayer:E,createPlayer:A,savePreferences:z,get VText(){return ne},get VButton(){return te},get VContainer(){return ee},Breadcrumbs:ae,LanguageSwitcher:oe,ref:S,computed:q,onMounted:J,onUnmounted:F,watch:M,get t(){return se},get toSong(){return U},get toStory(){return le},get useSong(){return Q}};return Object.defineProperty(R,"__isScriptSetup",{enumerable:!1,value:!0}),R}},ge={class:"song-page__title"},ue={class:"song-page__layout"},de={class:"song-page__main"},_e={class:"song-page__video-container"},ye=["id"],fe={key:0,class:"song-page__karaoke"},pe={class:"song-page__karaoke-title"},ve={class:"song-page__karaoke-content"},me=["innerHTML"],he={class:"song-page__controls-section"},Se={key:1,class:"song-page__story-card"},ke=["href"],we={class:"song-page__story-image"},Te=["src","alt"],be={class:"song-page__story-info"},Ie={class:"song-page__story-label"},xe={class:"song-page__story-title"},Le={key:2,class:"song-page__lyrics"},Ce={class:"song-page__lyrics-title"},Ae=["innerHTML"],De={class:"song-page__playlist"},Pe={class:"song-page__playlist-items"},Me=["onClick"],Ne={class:"song-page__playlist-number"},Be={key:0},Ve={key:1,viewBox:"0 0 24 24",fill:"currentColor"},He={class:"song-page__playlist-cover"},Ee=["src","alt"],ze={class:"song-page__playlist-info"};function Re(k,c,t,n,r,i){return p(),re(n.VContainer,{size:"xl",class:"song-page"},{default:P(()=>[L(n.Breadcrumbs,{"current-page":t.song.name,"saga-name":t.currentSaga?.name,"saga-key":t.currentSaga?.key},null,8,["current-page","saga-name","saga-key"]),L(n.LanguageSwitcher,{order:t.song.order,type:"song",class:"song-page__language-switcher"},null,8,["order"]),e("h1",ge,f(t.song.name),1),e("div",ue,[e("div",de,[e("div",_e,[e("div",{id:`youtube-player-${t.song.key}`,class:"song-page__video"},null,8,ye)]),t.song.syncedLyrics&&t.song.syncedLyrics.length>0?(p(),m("div",fe,[e("h2",pe,f(n.t("page.song.lyrics")),1),e("div",ve,[(p(!0),m(W,null,G(t.song.syncedLyrics,(l,g)=>(p(),m("div",{key:g,class:b({"song-page__karaoke-line":!0,"song-page__karaoke-line--active":n.isLineActive(l)}),innerHTML:n.normalizeLineText(l.text),suppressHydrationWarning:""},null,10,me))),128))])])):N("",!0),e("div",he,[e("button",{onClick:n.toggleRepeat,class:b([{active:n.isRepeat},"song-page__control"])},[c[0]||(c[0]=e("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M17 1l4 4-4 4M3 11V9a4 4 0 0 1 4-4h14M7 23l-4-4 4-4M21 13v2a4 4 0 0 1-4 4H3"})],-1)),e("span",null,f(n.t("page.song.repeat")),1)],2),e("button",{onClick:n.toggleAutoplay,class:b([{active:n.isAutoplay},"song-page__control"])},[c[1]||(c[1]=e("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M5 3l14 9-14 9V3z"}),e("path",{d:"M19 3v18"})],-1)),e("span",null,f(n.t("page.song.autoplay")),1)],2),e("button",{onClick:n.toggleShuffle,class:b([{active:n.isShuffle},"song-page__control"])},[c[2]||(c[2]=e("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"})],-1)),e("span",null,f(n.t("page.song.shuffle")),1)],2)]),t.relatedStory?(p(),m("div",Se,[e("a",{href:n.toStory(t.relatedStory.key),class:"song-page__story-link"},[e("div",we,[e("img",{src:`/assets/stories/${n.lang}/${t.relatedStory.key}.webp`,alt:t.relatedStory.name},null,8,Te)]),e("div",be,[e("span",Ie,f(n.t("page.song.readStory")),1),e("h3",xe,f(t.relatedStory.name),1)]),c[3]||(c[3]=e("svg",{class:"song-page__story-arrow",viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"})],-1))],8,ke)])):N("",!0),t.song.lyrics&&(!t.song.syncedLyrics||t.song.syncedLyrics.length===0)?(p(),m("div",Le,[e("h2",Ce,f(n.t("page.song.lyrics")),1),e("div",{class:"song-page__lyrics-content",innerHTML:n.lyricsHTML,suppressHydrationWarning:""},null,8,Ae)])):N("",!0)]),e("div",De,[L(n.VText,{variant:"subtitle",color:"high",class:"song-page__playlist-title"},{default:P(()=>[K(f(n.t("page.song.playlist")),1)]),_:1}),e("div",Pe,[(p(!0),m(W,null,G(t.allSongs,(l,g)=>(p(),m("div",{key:l.key,class:b([{"song-page__playlist-item--active":l.key===t.song.key,"song-page__playlist-item--playing":n.isPlaying&&l.key===t.song.key},"song-page__playlist-item"]),onClick:w=>n.navigateToSong(l.key)},[e("div",Ne,[!n.isPlaying||l.key!==t.song.key?(p(),m("span",Be,f(g+1),1)):(p(),m("svg",Ve,[...c[4]||(c[4]=[e("rect",{x:"6",y:"4",width:"4",height:"16",rx:"1"},[e("animate",{attributeName:"height",values:"4;16;4",dur:"1.2s",repeatCount:"indefinite",begin:"0s"}),e("animate",{attributeName:"y",values:"10;4;10",dur:"1.2s",repeatCount:"indefinite",begin:"0s"})],-1),e("rect",{x:"14",y:"4",width:"4",height:"16",rx:"1"},[e("animate",{attributeName:"height",values:"16;4;16",dur:"1.2s",repeatCount:"indefinite",begin:"0.3s"}),e("animate",{attributeName:"y",values:"4;10;4",dur:"1.2s",repeatCount:"indefinite",begin:"0.3s"})],-1)])]))]),e("div",He,[e("img",{src:`/assets/stories/${n.lang}/${l.key}.webp`,alt:l.name},null,8,Ee)]),e("div",ze,[L(n.VText,{variant:"body",color:"high"},{default:P(()=>[K(f(l.name),1)]),_:2},1024)])],10,Me))),128))])])])]),_:1})}const $e=ie(ce,[["render",Re]]);export{$e as default};
